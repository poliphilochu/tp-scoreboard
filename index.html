<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="UTF-8">
	<title>菜P得分板</title>
	<link rel="stylesheet" type="text/css" href="css/normalize.css" />
	<link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="vendor/papaparse/papaparse.min.js"></script>
	<script type="text/javascript">
	$(function() {
		var scoreboard = [];
		var $count = $(".count");
		var countTotal = $count.length;

		var isWinner = function() {
			console.log(scoreboard);
			var max = Math.max.apply(null, scoreboard);
			console.log(max);
			max = max.toString();
			var i = scoreboard.indexOf(max);
			console.log(i);
			$(".player").eq(i).addClass("is-winner");
			// $(this).closest(".player").addClass("is-winner");	
		}

		Papa.parse("https://poliphilochu.github.io/tp-scoreboard/data/tp-scoreboard-data.csv", {
			download: true,
			complete: function(results) {
				console.log(results);
				var row, rowTotal = results.data.length, pTotal = 0, tTotal = 0, pVals = [], tVals = [], updateTime;
				
				for (i = 0; i < rowTotal; i++) {
					if (i > 0) {
						row = results.data[i];
						if (row[1] && row[2]) {
							pTotal += row[1] ? parseInt(row[1]) : 0;
							tTotal += row[2] ? parseInt(row[2]) : 0;
						}
						else {
							// console.log('!!'+i);
							// console.log(row);
							if (!updateTime) {
								updateTime = results.data[i-1][0];
							}
						}
					}
				}

				$("#player-p .total-score").text(pTotal);
				$("#player-t .total-score").text(tTotal);

				$(".count").each(function(i) {
					var last = i == countTotal - 1 ? true : false;
					var score = $(this).text();
					scoreboard.push(score);

			    $(this).prop("Counter",0).animate({
			        Counter: score
			    }, {
			        duration: 2000,
			        easing: "swing",
			        step: function(now) {
		            $(this).text(Math.ceil(now));
			        },
			        complete: function() {
			        	if (last) {
			        		isWinner();
			        	}
			        }
			    });
				});

				$("<div id='update-time'>Last updated time: " + updateTime + "</div>").appendTo("#page");
			}
		});
	});
	</script>
</head>
<body>
<div id="page" class="container">
	<div id="player-p" class="player">
		<h2 class="player-name">朱</h2>
		<div class="total-score count"></div>
	</div>
	<div id="player-t" class="player">
		<h2 class="player-name">菜</h2>
		<div class="total-score count"></div>
	</div>
</div>
</body>
</html>